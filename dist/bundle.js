!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=(e,t)=>{e.style.display=t},t=()=>{const e=navigator.userAgent,t=e.indexOf("Android")>-1||e.indexOf("Adr")>-1,n=!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);return{isAndroid:t,isiOS:n,eventName:{mousedown:t||n?"touchstart":"mousedown",mouseup:t||n?"touchend":"mouseup",mousemove:t||n?"touchmove":"mousemove"}}},n=(e,t=[])=>{if(e.parentNode)for(let s=0;s<e.parentNode.childNodes.length;s++)e.parentNode.childNodes[s]===e&&(t.push(s),e.parentNode!==document.body&&n(e.parentNode,t));return t};window.webMarker=class{constructor(n){if(!n||!n.onSave)throw new Error("options中的 onSave 选项为必填");if("function"!=typeof n.onSave)throw new Error("onSave 必须为一个函数");this.markedStyles={color:"#fff",backgroundColor:"cadetblue",...n.markedStyles},this.onSave=n.onSave,this.selectedMarkers=[],this.selectedDom=null,this.selectedText={},this.currentSelectedDom=[],this.pageY=0,this.tempMarkerInfo={},this.deleteId="",this.userAgent=t(),Array.isArray(n.defaultMarkers)&&n.defaultMarkers.length>0&&this.setDefaultMarkers(n.defaultMarkers),((e,n)=>{const s={position:"fixed",textAlign:"center",width:"80%",left:"10%",height:"35px",lineHeight:"35px",backgroundColor:"black",borderRadius:3,display:"none",color:"#fff",...n},d=document.createElement("div");d.id="webMarkerBtnBox",Object.keys(s).forEach(e=>{d.style[e]=s[e]}),d.innerHTML='\n      <div style="flex: 1" id="webMarker_btn_mark">标记</div>\n      <div style="flex: 1" id="webMarker_btn_delete">删除当前标记</div>\n      <div style="flex: 1" id="webMarker_btn_cancel">取消</div>\n    ',document.body.appendChild(d),e.btn_Box=document.getElementById("webMarkerBtnBox"),e.btn_mark=document.getElementById("webMarker_btn_mark"),e.btn_cancel=document.getElementById("webMarker_btn_cancel"),e.btn_delete=document.getElementById("webMarker_btn_delete"),e.btn_mark.addEventListener(t().eventName.mousedown,e.mark.bind(e)),e.btn_cancel.addEventListener("click",e.hide.bind(e)),e.btn_delete.addEventListener("click",e.del.bind(e))})(this,n.btnStyles),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this)),document.addEventListener(this.userAgent.eventName.mousedown,t=>{const n=t.target;if("selected_text"===n.className)return this.pageY=t.pageY,e(this.btn_mark,"none"),e(this.btn_delete,"block"),this.deleteId=t.target.id,void this.show();this.currentSelectedDom=[],this.selectedDom=n,this.currentSelectedDom.push(n),document.addEventListener(this.userAgent.eventName.mousemove,this.handleMouseMove.bind(this)),document.addEventListener(this.userAgent.eventName.mouseup,this.handleMouseUp.bind(this))})}handleSelectionChange(){window.getSelection()&&(this.selectedText=window.getSelection())}handleMouseMove(e){this.currentSelectedDom.includes(e.target)||this.currentSelectedDom.push(e.target)}handleMouseUp(t){if(document.removeEventListener(this.userAgent.eventName.mousemove,this.handleMouseMove),document.removeEventListener(this.userAgent.eventName.mouseup,this.handleMouseUp),0===this.selectedText.toString().length||!this.selectedText.getRangeAt)return void this.hide();if(["BUTTON","H1","H2","IMG"].includes(this.selectedText.getRangeAt(0).commonAncestorContainer.parentNode.nodeName))return;if(this.currentSelectedDom.length>1)return;e(this.btn_mark,"block"),e(this.btn_delete,"none");const{anchorOffset:s,focusOffset:d}=this.selectedText;this.pageY=t.pageY;let o=0;for(let e=0;e<this.selectedDom.childNodes.length;e++)this.selectedDom.childNodes[e]===this.selectedText.anchorNode&&(o=e);const r=n(this.selectedDom,[]);this.tempMarkerInfo={id:(new Date).getTime(),domDeeps:r.reverse(),childIndex:o,startIndex:Math.min(s,d),endIndex:Math.max(s,d)},this.show()}hide(){e(this.btn_Box,"none")}show(){e(this.btn_Box,"flex"),this.btn_Box.style.top=this.pageY+20+"px"}mark(e){e.preventDefault(),e.stopPropagation();const t=this.selectedText.toString(),n=this.selectedText.getRangeAt(0);var s=document.createElement("span");s.className="selected_text",s.id=this.tempMarkerInfo.id,s.style.color=this.markedStyles.color,s.style.backgroundColor=this.markedStyles.backgroundColor,s.innerHTML=t,n.surroundContents(s),this.selectedMarkers.push(this.tempMarkerInfo),this.selectedText.removeAllRanges(),this.hide(),this.save()}save(){const e=JSON.stringify(this.selectedMarkers);t();this.onSave&&this.onSave(e)}del(){this.selectedMarkers.forEach((e,t)=>{const n=document.getElementById(this.deleteId),s=n.parentNode;if(e.id.toString()===this.deleteId){const d=n.innerText,o=document.createTextNode(d);s.replaceChild(o,n);const{domDeeps:r,childIndex:i,endIndex:a}=e,l=o.previousSibling,c=o.nextSibling;3===l.nodeType?(l.textContent=l.textContent+d,s.removeChild(o),3===c.nodeType&&(l.textContent=l.textContent+c.textContent,s.removeChild(c))):3===c.nodeType&&(o.textContent=o.textContent+c.textContent,s.removeChild(c)),this.selectedMarkers.forEach(e=>{JSON.stringify(e.domDeeps)===JSON.stringify(r)&&e.childIndex>i&&(e.childIndex=e.childIndex-2,e.startIndex=e.startIndex+a,e.endIndex=e.endIndex+a)}),this.selectedMarkers.splice(t,1),this.save()}})}setDefaultMarkers(e){this.selectedMarkers=e,e.forEach(e=>{const t=((e,t)=>{let n=document.body;return e.forEach(e=>{for(let t=0;t<n.childNodes.length;t++)t===e&&(n=n.childNodes[t])}),n.childNodes[t]})(e.domDeeps,e.childIndex);if(!t)return;const n=t.textContent,s=n.substr(0,e.startIndex),d=n.substr(e.startIndex,e.endIndex-e.startIndex),o=n.substr(e.endIndex);var r,i,a,l;t.textContent=`${s}${r=d,i=e.id,a=this.markedStyles.color,l=this.markedStyles.backgroundColor,`<span class="web_marker_selected" id="${i}" style="color: ${a}; background-color: ${l}">${r}</span>`}${o}`;const c=t.parentNode;let h=c.innerHTML;h=h.replace(/&lt;/g,"<").replace(/&gt;/g,">"),c.innerHTML=h})}}}));
//# sourceMappingURL=bundle.js.map
