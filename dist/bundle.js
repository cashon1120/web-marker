!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=(e,t)=>{e&&(e.style.display=t)},t=(e,t,s)=>{const n=document.createElement("span");return n.className=e,n.id=s,n.innerHTML=t,n},s=()=>{const e=navigator.userAgent,t=e.indexOf("Android")>-1||e.indexOf("Adr")>-1,s=!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),n=!t&&!s;return{isAndroid:t,isiOS:s,isPC:n,isSafari:/Safari/.test(e)&&!/Chrome/.test(e),eventName:{mousedown:n?"mousedown":"touchstart",mouseup:n?"mouseup":"touchend",mousemove:n?"mousemove":"touchmove"}}},n=(e,t=1)=>{if(e===document.body&&(e.className="_WM-0"),e.childNodes)for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1===i.nodeType){["BR","HR","SCRIPT","BUTTON"].includes(i.nodeName)||(i.className=i.className?i.className+` _WM-${t}-${s}`:`_WM-${t}-${s}`),i.childNodes.length>0&&n(i,t+1+"-"+s)}}},i=e=>{const t=e.parentNode;if(!t)return;const s=e.innerText,n=document.createTextNode(s);t.replaceChild(n,e);const i=n.previousSibling,o=n.nextSibling;i&&3===i.nodeType?(i.textContent=i.textContent+s,t.removeChild(n),o&&3===o.nodeType&&(i.textContent=i.textContent+o.textContent,t.removeChild(o))):o&&3===o.nodeType&&(n.textContent=n.textContent+o.textContent,t.removeChild(o))},o=e=>document.getElementById(e),r=e=>{const t=document.createElement("div");t.id="webMarkerDebugBox",((e,t)=>{Object.keys(t).forEach(s=>{e.style[s]=t[s]})})(t,{position:"fixed",width:"100%",bottom:0,left:0,padding:"10px",transition:"all .3s",boxSizing:"border-box",backgroundColor:"#f1f1f1",fontSize:"12px",borderTop:"1px solid #ddd"}),t.innerHTML='\n      <div id="debug_userAgaent"></div>\n      <div id="debug_selectionText">选中文本:</div>\n      <div id="debug_event">事件:</div>\n    ',document.body.appendChild(t),e.debug_userAgaent=document.getElementById("debug_userAgaent"),e.debug_selectionText=document.getElementById("debug_selectionText"),e.debug_event=document.getElementById("debug_event")},d=["BUTTON","H1","H2","IMG"];class a{constructor(e,t,s,n,i){this.id=e,this.childIndex=s,this.start=n,this.end=i,t&&(this.parentClassName=t)}}window.WebTextMarker=class{constructor(e){this.MARKED_CLASSNAME=e.markedClassName,this.TEMP_MARKED_CLASSNAME=e.selectedClassName,this.FOUCE_MARKED_CLASSNAME=e.focusMarkedClassName,this.options=e||{},this.btnWrapper=null,this.selectedMarkers={},this.selectedText={},this.tempMarkDom=null,this.hasTempDom=!1,this.tempMarkerInfo={},this.currentId=null,this.isMarked=!1,this.pageY=0,this.touch=null,this.init()}init(){const{defaultMarkers:e,debug:t}=this.options;this.userAgent=s(),n(document.body),t&&(r(this),this.debug_userAgaent.innerHTML=`\n        android: ${this.userAgent.isAndroid};&nbsp;&nbsp;&nbsp;\n        iOS: ${this.userAgent.isiOS};&nbsp;&nbsp;&nbsp;\n        pc: ${this.userAgent.isPC}`),e&&Object.keys(e).length>0&&(this.selectedMarkers=e,this.setDefaultMarkers()),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this)),document.addEventListener(this.userAgent.eventName.mousedown,this.handleMouseDown.bind(this)),this.userAgent.isPC&&document.addEventListener(this.userAgent.eventName.mouseup,this.handleMouseUp.bind(this))}handleSelectionChange(){if(window.getSelection()){if(this.selectedText=window.getSelection(),this.isMarked)return;if(this.userAgent.isPC)return!this.checkNoSelectionText()||this.isMarked||this.hasTempDom?void(this.tempMarkDom&&this.tempMarkDom.className.indexOf(this.MARKED_CLASSNAME)):void this.hide();const{commonAncestorContainer:e}=this.selectedText.getRangeAt(0);if(this.checkNoSelectionText()&&!this.isMarked||!this.checkSelectionCount()||d.includes(e.parentNode.nodeName))return void this.hide();this.selectedText.toString().length>0&&this.handleMouseUp()}else this.options.debug&&(this.debug_selectionText.innerHTML="不支持 window.getSelection 属性")}handleMouseDown(t){this.userAgent.isPC?this.pageY=t.pageY:this.touch=t.touches[0];const s=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];s&&(i(s),this.hide());const n=t.target;if(this.options.debug&&(this.debug_event.innerHTML=`当前坐标: ${this.pageY}, 点击目标: ${t.target.className}`),n.className.indexOf(this.MARKED_CLASSNAME)>-1)return this.removeFocusStyle(),n.className=`${this.MARKED_CLASSNAME} ${this.FOUCE_MARKED_CLASSNAME}`,e(document.getElementById(this.options.btnMarkID),"none"),e(document.getElementById(this.options.btnDeleteID),"block"),this.currentId=t.target.id,this.isMarked=!0,this.tempMarkDom=n,void setTimeout(()=>{this.show()},0);this.tempMarkDom=null,this.isMarked=!1,this.hide()}handleMouseUp(){if(this.userAgent.isPC){if(this.checkNoSelectionText())return;setTimeout(()=>{!this.checkNoSelectionText()||this.isMarked||this.hasTempDom||this.hide()},0);const{commonAncestorContainer:e}=this.selectedText.getRangeAt(0);if(!this.checkSelectionCount()||d.includes(e.parentNode.nodeName))return}const{commonAncestorContainer:s}=this.selectedText.getRangeAt(0);e(document.getElementById(this.options.btnMarkID),"block"),e(document.getElementById(this.options.btnDeleteID),"none");const{anchorOffset:n,focusOffset:i}=this.selectedText,o=Math.min(n,i),r=Math.max(n,i),h=s.parentNode.className.split(" ");let l=h[h.length-1];if(this.tempMarkerInfo=new a((new Date).getTime(),l,0,o,r),this.hasTempDom=!0,this.userAgent.isPC){const e=this.selectedText.toString(),s=this.selectedText.getRangeAt(0),n=t(this.TEMP_MARKED_CLASSNAME,e,this.tempMarkerInfo.id);s.surroundContents(n)}this.show()}hide(){if(e(this.btnWrapper,"none"),this.removeFocusStyle(),this.userAgent.isPC){const e=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];if(!e||e.className.indexOf(this.MARKED_CLASSNAME)>-1)return;i(e),this.hasTempDom=!1}else this.tempMarkDom=null}show(){this.btnWrapper||(this.btnWrapper=document.getElementById(this.options.btnWrapperID)),this.arrow||(this.arrow=document.getElementById(this.options.btnArrowID)),e(this.btnWrapper,"flex");let t=null,s="50%",n=0,i=null;i=this.tempMarkDom?this.tempMarkDom:document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0],i&&(t=i.getBoundingClientRect(),s=t.left+i.offsetWidth/2,t.width+t.left>window.innerWidth&&(s=t.left+5),n=t.top),s=Math.min(window.innerWidth-30,Math.max(10,s-15)),this.userAgent.isPC?(this.btnWrapper.style.top=n+window.scrollY-50+"px",this.arrow.style.left=s+"px"):(n=i?n+window.scrollY-50:this.touch.pageY-80,s=i?s:this.touch.pageX,this.btnWrapper.style.top=n+"px",this.arrow.style.left=s+"px")}resetMarker(e){const t=document.getElementsByClassName(e)[0],s=[];let n=0;for(let i=0;i<t.childNodes.length;i++){const o=t.childNodes[i];"#text"===o.nodeName&&(n=o.textContent.length);const r=i-1;this.selectedMarkers[e].forEach(e=>{t.childNodes[i].id==e.id&&s.push(new a(e.id,"",r,n,n+o.textContent.length))})}s.length>0?this.selectedMarkers[e]=s:delete this.selectedMarkers[e]}setDefaultMarkers(){const e=this.selectedMarkers;Object.keys(e).forEach(s=>{const n=document.getElementsByClassName(s)[0];n&&e[s].forEach(e=>{const s=n.childNodes[e.childIndex];s.splitText(e.start);const i=s.nextSibling;i.splitText(e.end-e.start);const o=t(this.MARKED_CLASSNAME,i.textContent,e.id);n.replaceChild(o,i)})})}checkSelectionCount(){return this.selectedText.getRangeAt(0).endContainer===this.selectedText.getRangeAt(0).startContainer}checkNoSelectionText(){return 0===this.selectedText.toString().length||!this.selectedText.getRangeAt}removeFocusStyle(){const e=document.getElementsByClassName(this.FOUCE_MARKED_CLASSNAME)[0];e&&(e.className=this.MARKED_CLASSNAME)}mark(){const{parentClassName:e}=this.tempMarkerInfo;if(this.userAgent.isPC){document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0].className=this.MARKED_CLASSNAME}else{const e=this.selectedText.toString(),s=this.selectedText.getRangeAt(0),n=t(this.MARKED_CLASSNAME,e,this.tempMarkerInfo.id);s.surroundContents(n)}this.selectedMarkers[e]?this.selectedMarkers[e].push(this.tempMarkerInfo):this.selectedMarkers[e]=[this.tempMarkerInfo],this.currentId=this.tempMarkerInfo.id,this.resetMarker(e),this.selectedText.removeAllRanges(),this.hide()}del(){if(!this.currentId)return;this.tempMarkDom=null;const e=document.getElementById(this.currentId),t=e.parentNode.className.split(" "),s=t[t.length-1];i(e),this.resetMarker(s)}getCurrentId(){return console.log(this),this.currentId}getAllMarkes(){return this.selectedMarkers}},window.addEventListener("load",()=>{var e,t;(()=>{const e=document.createElement("div");e.id="webMarkerBtnBox",e.innerHTML='<div>\n        <div id="webMarker_arrow"></div>\n        <div id="webMarker_btn_mark">高亮</div>\n        <div id="webMarker_btn_notes">笔记</div>\n        <div id="webMarker_btn_discuss">讨论</div>\n        <div id="webMarker_btn_delete">移除</div>\n        <div id="webMarker_btn_save">保存</div>\n      </div>\n    ',document.body.appendChild(e)})(),e="./style.css",(t=document.createElement("link")).rel="stylesheet",t.type="text/css",t.href=e,document.getElementsByTagName("head")[0].appendChild(t);let n={};window.jsObject&&window.jsObject.getCallBack?window.jsObject.getCallBack().length>0&&(n=JSON.parse(window.jsObject.getCallBack())):n=JSON.parse(localStorage.getItem("markers"));const i=new window.WebTextMarker({defaultMarkers:n,debug:!0,markedClassName:"_web_marker",focusMarkedClassName:"_focus_web_marker",selectedClassName:"_temp_marker",btnWrapperID:"webMarkerBtnBox",btnArrowID:"webMarker_arrow",btnMarkID:"webMarker_btn_mark",btnDeleteID:"webMarker_btn_delete"}),r=o("webMarker_btn_mark"),d=o("webMarker_btn_delete"),a=o("webMarker_btn_notes"),h=o("webMarker_btn_discuss"),l=o("webMarker_btn_save"),{mousedown:c}=s().eventName;r.addEventListener(c,()=>i.mark()),d.addEventListener(c,()=>{i.del()}),l.addEventListener(c,()=>{const e=JSON.stringify(i.getAllMarkes());i.userAgent.isAndroid&&window.jsObject?window.jsObject.save(e):i.userAgent.isiOS||localStorage.setItem("markers",e)}),a.addEventListener(c,()=>{i.mark();const e=i.getCurrentId();i.userAgent.isAndroid&&window.jsObject?window.jsObject.save(e):i.userAgent.isiOS||console.log("笔记",e)}),h.addEventListener(c,()=>{i.mark();const e=i.getCurrentId();i.userAgent.isAndroid&&window.jsObject?window.jsObject.save(e):i.userAgent.isiOS||console.log("讨论",e)})})}));
