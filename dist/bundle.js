!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=(e,t)=>{e.style.display=t},t=(e,t,s,n)=>{const i=document.createElement("span");return i.className=e,i.id=s,i.innerHTML=t,n&&Object.keys(n).forEach(e=>{i.style[e]=n[e]}),i},s=()=>{const e=navigator.userAgent,t=e.indexOf("Android")>-1||e.indexOf("Adr")>-1,s=!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),n=!t&&!s;return{isAndroid:t,isiOS:s,isPC:n,isSafari:/Safari/.test(e)&&!/Chrome/.test(e),eventName:{mousedown:n?"mousedown":"touchstart",mouseup:n?"mouseup":"touchend",mousemove:n?"mousemove":"touchmove"}}},n=(e,t=1)=>{if(e===document.body&&(e.className="_WM-0"),e.childNodes)for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1===i.nodeType){["BR","HR","SCRIPT","BUTTON"].includes(i.nodeName)||(i.className=i.className?i.className+` _WM-${t}-${s}`:`_WM-${t}-${s}`),i.childNodes.length>0&&n(i,t+1+"-"+s)}}},i=e=>{const t=e.parentNode;if(!t)return;const s=e.innerText,n=document.createTextNode(s);t.replaceChild(n,e);const i=n.previousSibling,o=n.nextSibling;i&&3===i.nodeType?(i.textContent=i.textContent+s,t.removeChild(n),o&&3===o.nodeType&&(i.textContent=i.textContent+o.textContent,t.removeChild(o))):o&&3===o.nodeType&&(n.textContent=n.textContent+o.textContent,t.removeChild(o))},o=(e,t)=>{Object.keys(t).forEach(s=>{e.style[s]=t[s]})},r=["BUTTON","H1","H2","IMG"];class d{constructor(e,t,s,n,i){this.id=e,this.childIndex=s,this.start=n,this.end=i,t&&(this.parentClassName=t)}}window.WebTextMarker=class{constructor(e){if(!e||!e.onSave)throw new Error("options中的 onSave 选项为必填");if("function"!=typeof e.onSave)throw new Error("onSave 必须为一个函数");if(e.markedStyles&&"[object Object]"===Object.prototype.toString.call(e.markedStyles))throw new Error("标记样式 markedStyles 必须为一个对象");if(e.btnStyles&&"[object Object]"===Object.prototype.toString.call(e.btnStyles))throw new Error("按钮样式 btnStyles 必须为一个对象");if(e.focusMarkedStyles&&"[object Object]"===Object.prototype.toString.call(e.focusMarkedStyles))throw new Error("标记高亮样式 focusMarkedStyles 必须为一个对象");this.MARKED_CLASSNAME="_web_marker",this.TEMP_MARKED_CLASSNAME="_temp_marker",this.FOUCE_MARKED_CLASSNAME="_focus_web_marker",this.markedStyles={color:"#fff",backgroundColor:"cadetblue",...e.markedStyles},this.focusMarkedStyles={color:"#fff",backgroundColor:"#ffb400",...e.focusMarkedStyles},this.tempMarkerStyles={color:"#fff",backgroundColor:"#000",...e.focusMarkedStyles},this.options=e||{},this.selectedMarkers={},this.selectedText={},this.tempMarkDom=null,this.hasTempDom=!1,this.tempMarkerInfo={},this.deleteId="",this.isMarked=!1,this.pageY=0,this.touch=null,this.init()}init(){const{defaultMarkers:e,btnStyles:t,debug:i}=this.options;this.userAgent=s(),n(document.body),((e,t)=>{const n={position:"absolute",textAlign:"center",width:"100%",left:0,top:0,padding:"0 15px",height:"35px",lineHeight:"35px",backgroundColor:"black",borderRadius:3,display:"none",color:"#fff",transition:"all .3s",boxSizing:"border-box",...t},i=document.createElement("div");i.id="webMarkerBtnBox",o(i,n),i.style.backgroundColor="transparent";const r=`flex: 1; background-color: ${n.backgroundColor}; border-right: 1px solid rgba(255,255,255,.3); box-sizing: border-box;`;i.innerHTML=`\n      <div style="${r}" id="webMarker_btn_mark">标记</div>\n      <div style="${r}" id="webMarker_btn_delete">删除选中标记</div>\n      <div style="${r}" id="webMarker_btn_cancel">取消</div>\n      <div style="${r}; border-right: 0" id="webMarker_btn_save">保存所有</div>\n      <div id="webMarker_arrow"></div>\n    `,document.body.appendChild(i);const d=document.getElementById("webMarker_arrow");d.style.position="absolute",d.style.width="10px",d.style.height="10px",d.style.backgroundColor=n.backgroundColor,d.style.left="50%",d.style.marginLeft="-5px",d.style.bottom="-5px",d.style.transform="rotate(45deg)",d.style.transition="all .3s",e.arrow=d,e.btn_Box=document.getElementById("webMarkerBtnBox"),e.btn_mark=document.getElementById("webMarker_btn_mark"),e.btn_cancel=document.getElementById("webMarker_btn_cancel"),e.btn_delete=document.getElementById("webMarker_btn_delete"),e.btn_save=document.getElementById("webMarker_btn_save"),e.btn_mark.addEventListener(s().eventName.mousedown,e.mark.bind(e)),e.btn_cancel.addEventListener(s().eventName.mousedown,e.hide.bind(e)),e.btn_delete.addEventListener(s().eventName.mousedown,e.del.bind(e)),e.btn_save.addEventListener(s().eventName.mousedown,e.save.bind(e))})(this,t),i&&((e=>{const t=document.createElement("div");t.id="webMarkerDebugBox",o(t,{position:"fixed",width:"100%",bottom:0,left:0,padding:"10px",transition:"all .3s",boxSizing:"border-box",backgroundColor:"#f1f1f1",fontSize:"12px",borderTop:"1px solid #ddd"}),t.innerHTML='\n      <div id="debug_userAgaent"></div>\n      <div id="debug_selectionText">选中文本:</div>\n      <div id="debug_event">事件:</div>\n    ',document.body.appendChild(t),e.debug_userAgaent=document.getElementById("debug_userAgaent"),e.debug_selectionText=document.getElementById("debug_selectionText"),e.debug_event=document.getElementById("debug_event")})(this),this.debug_userAgaent.innerHTML=`\n        android: ${this.userAgent.isAndroid};&nbsp;&nbsp;&nbsp;\n        iOS: ${this.userAgent.isiOS};&nbsp;&nbsp;&nbsp;\n        pc: ${this.userAgent.isPC}`),e&&Object.keys(e).length>0&&(this.selectedMarkers=e,this.setDefaultMarkers()),document.addEventListener("selectionchange",this.handleSelectionChange.bind(this)),document.addEventListener(this.userAgent.eventName.mousedown,this.handleMouseDown.bind(this)),this.userAgent.isPC&&document.addEventListener(this.userAgent.eventName.mouseup,this.handleMouseUp.bind(this))}handleSelectionChange(){if(window.getSelection()){if(this.selectedText=window.getSelection(),this.isMarked)return;if(this.userAgent.isPC)return!this.checkNoSelectionText()||this.isMarked||this.hasTempDom?void(this.tempMarkDom&&this.tempMarkDom.className.indexOf(this.MARKED_CLASSNAME)):void this.hide();const{commonAncestorContainer:e}=this.selectedText.getRangeAt(0);if(this.checkNoSelectionText()&&!this.isMarked||!this.checkSelectionCount()||r.includes(e.parentNode.nodeName))return void this.hide();this.selectedText.toString().length>0&&this.handleMouseUp()}else this.options.debug&&(this.debug_selectionText.innerHTML="不支持 window.getSelection 属性")}handleMouseDown(t){this.userAgent.isPC?this.pageY=t.pageY:this.touch=t.touches[0];const s=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];s&&(i(s),this.hide());const n=t.target;if(this.options.debug&&(this.debug_event.innerHTML=`当前坐标: ${this.pageY}, 点击目标: ${t.target.className}`),n.className.indexOf(this.MARKED_CLASSNAME)>-1)return this.removeFocusStyle(),n.className=`${this.MARKED_CLASSNAME} ${this.FOUCE_MARKED_CLASSNAME}`,o(n,this.focusMarkedStyles),e(this.btn_mark,"none"),e(this.btn_delete,"block"),this.deleteId=t.target.id,this.isMarked=!0,this.tempMarkDom=n,void setTimeout(()=>{this.show()},0);this.tempMarkDom=null,this.isMarked=!1}handleMouseUp(){if(this.userAgent.isPC){if(this.checkNoSelectionText())return;setTimeout(()=>{!this.checkNoSelectionText()||this.isMarked||this.hasTempDom||this.hide()},0);const{commonAncestorContainer:e}=this.selectedText.getRangeAt(0);if(!this.checkSelectionCount()||r.includes(e.parentNode.nodeName))return}const{commonAncestorContainer:s}=this.selectedText.getRangeAt(0);e(this.btn_mark,"block"),e(this.btn_delete,"none");const{anchorOffset:n,focusOffset:i}=this.selectedText,o=Math.min(n,i),a=Math.max(n,i),l=s.parentNode.className.split(" ");let c=l[l.length-1];if(this.tempMarkerInfo=new d((new Date).getTime(),c,0,o,a),this.hasTempDom=!0,this.userAgent.isPC){const e=this.selectedText.toString(),s=this.selectedText.getRangeAt(0),n=t(this.TEMP_MARKED_CLASSNAME,e,this.tempMarkerInfo.id,this.tempMarkerStyles);s.surroundContents(n)}this.show()}hide(){if(e(this.btn_Box,"none"),this.removeFocusStyle(),this.userAgent.isPC){const e=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];if(!e||e.className.indexOf(this.MARKED_CLASSNAME)>-1)return;i(e),this.hasTempDom=!1}else this.tempMarkDom=null}show(){e(this.btn_Box,"flex");let t=null,s="50%",n=0,i=null;i=this.tempMarkDom?this.tempMarkDom:document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0],i&&(t=i.getBoundingClientRect(),s=t.left+i.offsetWidth/2,t.width+t.left>window.innerWidth&&(s=t.left+5),n=t.top),this.userAgent.isPC?(this.btn_Box.style.top=n+window.scrollY-50+"px",this.arrow.style.left=s+"px"):(n=i?n+window.scrollY-50:this.touch.pageY-80,s=i?s:this.touch.pageX,this.debug_event.innerHTML=n,this.btn_Box.style.top=n+"px",this.arrow.style.left=s+"px")}mark(e){e.stopPropagation();const{parentClassName:s}=this.tempMarkerInfo;if(this.userAgent.isPC){const e=document.getElementsByClassName(this.TEMP_MARKED_CLASSNAME)[0];e.className=this.MARKED_CLASSNAME,Object.keys(this.markedStyles).forEach(t=>{e.style[t]=this.markedStyles[t]})}else{const e=this.selectedText.toString(),s=this.selectedText.getRangeAt(0),n=t(this.MARKED_CLASSNAME,e,this.tempMarkerInfo.id,this.markedStyles);s.surroundContents(n)}this.selectedMarkers[s]?this.selectedMarkers[s].push(this.tempMarkerInfo):this.selectedMarkers[s]=[this.tempMarkerInfo],this.resetMarker(s),this.selectedText.removeAllRanges(),this.hide()}resetMarker(e){const t=document.getElementsByClassName(e)[0],s=[];let n=0;for(let i=0;i<t.childNodes.length;i++){const o=t.childNodes[i];"#text"===o.nodeName&&(n=o.textContent.length);const r=i-1;this.selectedMarkers[e].forEach(e=>{t.childNodes[i].id==e.id&&s.push(new d(e.id,"",r,n,n+o.textContent.length))})}s.length>0?this.selectedMarkers[e]=s:delete this.selectedMarkers[e]}save(){console.log(this.selectedMarkers),this.options.onSave&&this.options.onSave(this.selectedMarkers),this.hide()}del(e){e.preventDefault(),this&&(this.tempMarkDom=null);const t=document.getElementById(this.deleteId),s=t.parentNode.className.split(" "),n=s[s.length-1];i(t),this.resetMarker(n),this.save()}setDefaultMarkers(){const e=this.selectedMarkers;Object.keys(e).forEach(s=>{const n=document.getElementsByClassName(s)[0];e[s].forEach(e=>{const s=n.childNodes[e.childIndex];s.splitText(e.start);const i=s.nextSibling;i.splitText(e.end-e.start);const o=t(this.MARKED_CLASSNAME,i.textContent,e.id,this.markedStyles);n.replaceChild(o,i)})})}checkSelectionCount(){return this.selectedText.getRangeAt(0).endContainer===this.selectedText.getRangeAt(0).startContainer}checkNoSelectionText(){return 0===this.selectedText.toString().length||!this.selectedText.getRangeAt}removeFocusStyle(){const e=document.getElementsByClassName(this.FOUCE_MARKED_CLASSNAME)[0];e&&(e.className=this.MARKED_CLASSNAME,o(e,this.markedStyles))}},window.addEventListener("load",()=>{let e={};window.jsObject&&window.jsObject.getCallBack?(window.jsObject.getCallBack().length>0&&(e=JSON.parse(window.jsObject.getCallBack())),document.getElementById("windowobject").innerHTML=window.jsObject.getCallBack().length):(e=JSON.parse(localStorage.getItem("markers")),document.getElementById("windowobject").innerHTML="没有 getCallBack 对象");const t=new window.WebTextMarker({defaultMarkers:e,debug:!0,onSave:e=>{const s=JSON.stringify(e);t.userAgent.isAndroid&&window.jsObject?window.jsObject.save(s):t.userAgent.isiOS||localStorage.setItem("markers",s)}})})}));
//# sourceMappingURL=bundle.js.map
